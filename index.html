<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Latino Dance Video Contest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1516026672322-bc52d61a55d5?auto=format&fit=crop&w=1920');
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body class="min-h-screen flex flex-col font-sans">
  <header class="bg-red-800 p-4 text-center">
    <h1 class="text-3xl font-bold">Latino Dance Video Contest</h1>
    <nav class="mt-2">
      <button onclick="showPage('home')" class="mx-2 text-white hover:underline">Home</button>
      <button onclick="showPage('voting')" class="mx-2 text-white hover:underline">Voting</button>
      <button onclick="showPage('results')" class="mx-2 text-white hover:underline">Results</button>
      <button onclick="showPage('admin')" class="mx-2 text-white hover:underline">Admin</button>
    </nav>
  </header>

  <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
    <!-- Home Page -->
    <section id="home" class="space-y-4">
      <h2 class="text-2xl font-semibold">Welcome to the Latino Dance Contest!</h2>
      <p>Watch this week's Latino dance videos and vote for your top 3 favorites. Voting is open to everyone—just submit your name when you vote. Check the Results page to see the winners!</p>
      <div id="video-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- Voting Page -->
    <section id="voting" class="hidden space-y-4">
      <h2 class="text-2xl font-semibold">Vote for Your Favorite Videos</h2>
      <p>Select your top 3 videos (1st: 3 points, 2nd: 2 points, 3rd: 1 point) and submit with your name. You can only vote once per week.</p>
      <form id="vote-form" class="space-y-4">
        <div>
          <label class="block">Your Name:</label>
          <input type="text" id="voter-name" class="w-full p-2 text-black rounded" required>
        </div>
        <div>
          <label class="block">1st Choice (3 points):</label>
          <select id="vote1" class="w-full p-2 text-black rounded" required></select>
        </div>
        <div>
          <label class="block">2nd Choice (2 points):</label>
          <select id="vote2" class="w-full p-2 text-black rounded" required></select>
        </div>
        <div>
          <label class="block">3rd Choice (1 point):</label>
          <select id="vote3" class="w-full p-2 text-black rounded" required></select>
        </div>
        <button type="button" onclick="submitVote()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Submit Vote</button>
      </form>
      <p id="vote-message" class="text-green-400 hidden">Vote submitted successfully!</p>
    </section>

    <!-- Results Page -->
    <section id="results" class="hidden space-y-4">
      <h2 class="text-2xl font-semibold">Voting Results</h2>
      <div id="results-content"></div>
    </section>

    <!-- Admin Page -->
    <section id="admin" class="hidden space-y-4">
      <h2 class="text-2xl font-semibold">Admin Dashboard</h2>
      <div id="admin-login" class="space-y-4">
        <input type="password" id="admin-password" class="w-full p-2 text-black rounded" placeholder="Enter admin password">
        <button onclick="loginAdmin()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Login</button>
      </div>
      <div id="admin-panel" class="hidden space-y-4">
        <div>
          <h3 class="text-xl">Add New Video</h3>
          <input type="text" id="video-url" class="w-full p-2 text-black rounded" placeholder="YouTube Video URL">
          <button onclick="addVideo()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Add Video</button>
        </div>
        <div>
          <h3 class="text-xl">Current Videos</h3>
          <ul id="admin-video-list" class="space-y-2"></ul>
        </div>
        <div>
          <h3 class="text-xl">Manage Votes</h3>
          <ul id="vote-list" class="space-y-2"></ul>
        </div>
        <div>
          <h3 class="text-xl">Results Visibility</h3>
          <button onclick="toggleResults()" id="toggle-results-btn" class="bg-red-600 text-white p-2 rounded hover:bg-red-700"></button>
        </div>
        <div>
          <h3 class="text-xl">Reset Week</h3>
          <button onclick="resetWeek()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700">Start New Week</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-red-800 p-4 text-center">
    <p>© 2025 Latino Dance Video Contest</p>
  </footer>

  <script type="module">
    // Import Firebase modular SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
  apiKey: "AIzaSyBj0ciTxc57hsXfct1iXkf8hdd1nyN1OEs",
  authDomain: "new-latino-dance-contest.firebaseapp.com",
  projectId: "new-latino-dance-contest",
  storageBucket: "new-latino-dance-contest.firebasestorage.app",
  messagingSenderId: "453438352391",
  appId: "1:453438352391:web:8ccfc2a63650ff10bc8ea2",
  measurementId: "G-L0PSE4Y3KG"
    };

    // Initialize Firebase with error handling
    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log('Firebase initialized successfully');
      // Test Firestore connection
      await setDoc(doc(db, 'test', 'ping'), { timestamp: Date.now() });
      console.log('Firestore test write successful');
    } catch (error) {
      console.error('Firebase initialization failed:', error.message, error.code);
      alert('Failed to connect to the database. Error: ' + error.message);
    }

    const ADMIN_PASSWORD = "salsa2025"; // Change to a secure password
    let videos = [];
    let votes = [];
    let resultsVisible = false;
    let currentWeek = 1;

    // Ensure showPage is defined before any onclick handlers
    window.showPage = function(pageId) {
      console.log('Showing page:', pageId);
      document.querySelectorAll('main section').forEach(section => section.classList.add('hidden'));
      document.getElementById(pageId).classList.remove('hidden');
      if (pageId === 'home') renderVideos();
      if (pageId === 'voting') renderVoteForm();
      if (pageId === 'results') renderResults();
      if (pageId === 'admin') document.getElementById('admin-panel').classList.add('hidden');
    };

    // Initialize Firestore listeners with error handling
    function initFirestore() {
      if (!db) {
        console.error('Firestore not initialized');
        alert('Database not connected. Please check your Firebase setup.');
        return;
      }
      try {
        // Ensure week document exists
        setDoc(doc(db, 'weeks', `week-${currentWeek}`), { resultsVisible: false }, { merge: true })
          .then(() => console.log('Week document initialized'))
          .catch(error => console.error('Error initializing week document:', error));

        // Listen for videos
        onSnapshot(collection(db, 'weeks', `week-${currentWeek}`, 'videos'),
          snapshot => {
            videos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log('Videos fetched:', videos);
            renderVideos();
            renderVoteForm();
            renderAdminVideos();
            renderResults();
          },
          error => {
            console.error('Error fetching videos:', error.message, error.code);
            alert('Failed to load videos: ' + error.message);
          }
        );

        // Listen for votes
        onSnapshot(collection(db, 'weeks', `week-${currentWeek}`, 'votes'),
          snapshot => {
            votes = snapshot.docs.map(doc => ({ voterName: doc.id, votes: doc.data().votes }));
            console.log('Votes fetched:', votes);
            renderAdminVotes();
            renderResults();
          },
          error => {
            console.error('Error fetching votes:', error.message, error.code);
            alert('Failed to load votes: ' + error.message);
          }
        );

        // Listen for results visibility
        onSnapshot(doc(db, 'weeks', `week-${currentWeek}`),
          docSnapshot => {
            resultsVisible = docSnapshot.data()?.resultsVisible || false;
            console.log('Results visibility:', resultsVisible);
            updateToggleResultsButton();
            renderResults();
          },
          error => {
            console.error('Error fetching results visibility:', error.message, error.code);
            alert('Failed to load results settings: ' + error.message);
          }
        );
      } catch (error) {
        console.error('Error initializing Firestore listeners:', error.message, error.code);
        alert('Error connecting to the database: ' + error.message);
      }
    }

    function renderVideos() {
      const videoList = document.getElementById('video-list');
      videoList.innerHTML = '';
      videos.forEach(video => {
        const div = document.createElement('div');
        div.innerHTML = `
          <h3 class="text-lg font-semibold">${video.title}</h3>
          <div class="video-container">
            <iframe src="${video.url}" frameborder="0" allowfullscreen></iframe>
          </div>`;
        videoList.appendChild(div);
      });
    }

    function renderVoteForm() {
      const selects = [document.getElementById('vote1'), document.getElementById('vote2'), document.getElementById('vote3')];
      selects.forEach(select => {
        select.innerHTML = '<option value="">Select a video</option>';
        videos.forEach(video => {
          select.innerHTML += `<option value="${video.id}">${video.title}</option>`;
        });
      });
    }

    async function submitVote() {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      const voterName = document.getElementById('voter-name').value.trim();
      const vote1 = document.getElementById('vote1').value;
      const vote2 = document.getElementById('vote2').value;
      const vote3 = document.getElementById('vote3').value;

      if (!voterName || !vote1 || !vote2 || !vote3) {
        alert('Please fill in all fields.');
        return;
      }
      if (vote1 === vote2 || vote2 === vote3 || vote1 === vote3) {
        alert('Please select different videos for each choice.');
        return;
      }
      try {
        const voteRef = doc(db, 'weeks', `week-${currentWeek}`, 'votes', voterName);
        const docSnap = await getDoc(voteRef);
        if (docSnap.exists()) {
          alert('You have already voted this week.');
          return;
        }
        await setDoc(voteRef, { votes: [{ id: vote1, points: 3 }, { id: vote2, points: 2 }, { id: vote3, points: 1 }] });
        document.getElementById('vote-form').reset();
        document.getElementById('vote-message').classList.remove('hidden');
        setTimeout(() => document.getElementById('vote-message').classList.add('hidden'), 3000);
      } catch (error) {
        console.error('Error submitting vote:', error.message, error.code);
        alert('Error submitting vote: ' + error.message);
      }
    }

    window.loginAdmin = function() {
      console.log('Attempting admin login');
      const password = document.getElementById('admin-password').value;
      console.log('Entered password:', password);
      if (password === ADMIN_PASSWORD) {
        console.log('Password correct, showing admin panel');
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        renderAdminVideos();
        renderAdminVotes();
        updateToggleResultsButton();
      } else {
        console.log('Incorrect password');
        alert('Incorrect password.');
      }
    };

    async function addVideo() {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      const url = document.getElementById('video-url').value.trim();
      if (!url.includes('youtube.com/watch?v=')) {
        alert('Please enter a valid YouTube URL.');
        return;
      }
      const id = url.split('v=')[1].split('&')[0];
      const title = `Video ${videos.length + 1}`;
      try {
        console.log('Adding video:', { title, url: `https://www.youtube.com/embed/${id}` });
        await setDoc(doc(collection(db, 'weeks', `week-${currentWeek}`, 'videos')), {
          id: Date.now().toString(),
          title,
          url: `https://www.youtube.com/embed/${id}`
        });
        document.getElementById('video-url').value = '';
        console.log('Video added successfully');
      } catch (error) {
        console.error('Error adding video:', error.message, error.code);
        alert('Error adding video: ' + error.message);
      }
    }

    async function deleteVideo(videoId) {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      try {
        console.log('Deleting video:', videoId);
        await deleteDoc(doc(db, 'weeks', `week-${currentWeek}`, 'videos', videoId));
        const voteDocs = await getDocs(collection(db, 'weeks', `week-${currentWeek}`, 'votes'));
        for (const voteDoc of voteDocs) {
          const voteData = voteDoc.data();
          const updatedVotes = voteData.votes.filter(v => v.id !== videoId);
          if (updatedVotes.length !== voteData.votes.length) {
            await setDoc(voteDoc.ref, { votes: updatedVotes });
          }
        }
        console.log('Video deleted successfully');
      } catch (error) {
        console.error('Error deleting video:', error.message, error.code);
        alert('Error deleting video: ' + error.message);
      }
    }

    function renderAdminVideos() {
      const videoList = document.getElementById('admin-video-list');
      videoList.innerHTML = '';
      videos.forEach(video => {
        videoList.innerHTML += `
          <li class="flex justify-between">
            <span>${video.title}</span>
            <button onclick="deleteVideo('${video.id}')" class="text-red-400 hover:text-red-600">Delete</button>
          </li>`;
      });
    }

    async function deleteVote(voterName) {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      try {
        console.log('Deleting vote for:', voterName);
        await deleteDoc(doc(db, 'weeks', `week-${currentWeek}`, 'votes', voterName));
        console.log('Vote deleted successfully');
      } catch (error) {
        console.error('Error deleting vote:', error.message, error.code);
        alert('Error deleting vote: ' + error.message);
      }
    }

    function renderAdminVotes() {
      const voteList = document.getElementById('vote-list');
      voteList.innerHTML = '';
      votes.forEach(vote => {
        voteList.innerHTML += `
          <li class="flex justify-between">
            <span>${vote.voterName}</span>
            <button onclick="deleteVote('${vote.voterName}')" class="text-red-400 hover:text-red-600">Delete</button>
          </li>`;
      });
    }

    async function toggleResults() {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      try {
        console.log('Toggling results visibility to:', !resultsVisible);
        resultsVisible = !resultsVisible;
        await setDoc(doc(db, 'weeks', `week-${currentWeek}`), { resultsVisible }, { merge: true });
        updateToggleResultsButton();
        console.log('Results visibility updated');
      } catch (error) {
        console.error('Error toggling results:', error.message, error.code);
        alert('Error toggling results: ' + error.message);
      }
    }

    function updateToggleResultsButton() {
      document.getElementById('toggle-results-btn').textContent = resultsVisible ? 'Hide Results' : 'Show Results';
    }

    async function resetWeek() {
      if (!db) {
        alert('Database not connected. Please try again later.');
        return;
      }
      try {
        console.log('Resetting to week:', currentWeek + 1);
        currentWeek++;
        videos = [];
        votes = [];
        resultsVisible = false;
        await setDoc(doc(db, 'weeks', `week-${currentWeek}`), { resultsVisible: false });
        renderAdminVideos();
        renderVideos();
        renderVoteForm();
        renderAdminVotes();
        updateToggleResultsButton();
        console.log('Week reset successfully');
      } catch (error) {
        console.error('Error resetting week:', error.message, error.code);
        alert('Error resetting week: ' + error.message);
      }
    }

    // Initialize
    console.log('Initializing site');
    initFirestore();
    showPage('home');
  </script>
</body>
</html>
